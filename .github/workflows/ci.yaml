name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production

      - name: Run unit tests
        run: npm test -- --coverage --passWithNoTests
        env:
          CI: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          directory: coverage
          fail_ci_if_error: false

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: test
    if: failure()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create notification issue
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            const title = `üö® CI Test Failed - ${context.payload.repository.name}`;
            const body = `CI —Ç–µ—Å—Ç –∞–º–∂–∏–ª—Ç–≥“Ø–π –±–æ–ª–ª–æ–æ!
            
            **Repository:** ${context.repo.owner}/${context.repo.repo}
            **Branch:** ${context.ref}
            **Commit:** ${context.sha}
            **Author:** ${context.actor}
            
            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            
            **–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            
            –≠–Ω—ç issue –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä “Ø“Ø—Å—Å—ç–Ω. –¢–µ—Å—Ç –∞–º–∂–∏–ª—Ç—Ç–∞–π –±–æ–ª—Å–Ω—ã –¥–∞—Ä–∞–∞ —Ö–∞–∞–∂ –±–æ–ª–Ω–æ.`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['ci-failure', 'automated', 'frontend']
            });

      - name: Send email notification (optional)
        uses: dawidd6/action-send-mail@v3
        if: failure()
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'üö® CI Test Failed - Room Rent Frontend'
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions
          body: |
            CI —Ç–µ—Å—Ç –∞–º–∂–∏–ª—Ç–≥“Ø–π –±–æ–ª–ª–æ–æ!
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            Workflow: ${{ github.workflow }}
            Run ID: ${{ github.run_id }}
            
            –î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          secure: true

