name: CD

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deployment Status
        run: |
          echo "‚úÖ Deployment successful!"
          echo "Deployment URL: ${{ steps.deploy.outputs.url }}"

  notify:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment notification
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.deploy.result }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            const title = `${emoji} CD Deployment ${status === 'success' ? 'Success' : 'Failed'} - ${context.payload.repository.name}`;
            const body = `CD deployment ${status === 'success' ? '–∞–º–∂–∏–ª—Ç—Ç–∞–π' : '–∞–º–∂–∏–ª—Ç–≥“Ø–π'} –±–æ–ª–ª–æ–æ!
            
            **Repository:** ${context.repo.owner}/${context.repo.repo}
            **Branch:** ${context.ref}
            **Commit:** ${context.sha}
            **Author:** ${context.actor}
            
            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            
            **–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            
            ${status === 'success' ? 'Deployment –∞–º–∂–∏–ª—Ç—Ç–∞–π –±–æ–ª–ª–æ–æ! üéâ' : 'Deployment –∞–º–∂–∏–ª—Ç–≥“Ø–π –±–æ–ª–ª–æ–æ. –®–∞–ª–≥–∞–∞–¥ –∑–∞—Å–≤–∞—Ä–ª–∞–Ω–∞ —É—É.'}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: status === 'success' ? ['deployment', 'success', 'automated'] : ['deployment', 'failure', 'automated']
            });

      - name: Send email notification (optional)
        uses: dawidd6/action-send-mail@v3
        if: always()
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: '${{ needs.deploy.result == "success" && "‚úÖ" || "‚ùå" }} CD Deployment ${{ needs.deploy.result == "success" && "Success" || "Failed" }} - Room Rent Frontend'
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions
          body: |
            CD deployment ${{ needs.deploy.result == "success" && "–∞–º–∂–∏–ª—Ç—Ç–∞–π" || "–∞–º–∂–∏–ª—Ç–≥“Ø–π" }} –±–æ–ª–ª–æ–æ!
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            Workflow: ${{ github.workflow }}
            Run ID: ${{ github.run_id }}
            
            –î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          secure: true

